# Tips and tricks for video card passthrough to virtual machines

1. enable virtualization in motherboard/BIOS options
    - this varies by platform, but requires going into advanced BIOS options and enabling the appropriate CPU virtualization option
    - although we want to pass through the GPU, we do this through PCI-express passthrough, which is managed by the CPU
    - the exact BIOS terms keep changing, and may be listed as ["VT-x, AMD-V, SVM, or Vanderpool. Enable Intel VT-d or AMD IOMMU if the options are available."](https://bce.berkeley.edu/enabling-virtualization-in-your-pc-bios.html)
2. expose the graphics card using VFIO
    - [This](https://forum.level1techs.com/t/vfio-in-2019-pop-os-how-to-general-guide-though-draft/142287) is the most thorough guide I found. The [Arch Linux wiki](https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF) also has a lot of details.
    - Beware following the ArchWiki as step-by-step, as it includes a lot of advice for legacy/older Linux kernels. Modern kernels have the `vfio-pci` driver built-in so you don't need to load it separately.
    - You'll need to bind your graphics card(s) to `vfio-pci`. If you have UNIQUE graphics cards (e.g. a gtx1080 and a gtx970), you can simply pass the device ID for the device(s) you want to virtualize as [kernel parameters](https://wiki.archlinux.org/index.php/Kernel_parameters) to  `vfio-pci`.
    - If you do NOT have unique graphics cards (e.g. you have multiple gtx1080's for multiple virtual machines), they will all have the same device ID. If you use the kernel parameter approach, but you still need one of the graphics cards on your host machine, you will immediately lose access to that GPU on boot. To avoid this, you'll need to use the device address instead of the ID, and write a startup script that binds these to `vfio-pci` early in the boot process. [This guide mentioned earlier](https://forum.level1techs.com/t/vfio-in-2019-pop-os-how-to-general-guide-though-draft/142287) can walk you through - look for "Identical GPUs" on the page.
3. set up your (Windows) virtual machine
    - On Ubuntu, this can be achieved using `libvert` and KVM/QEMU. The [ArchWiki](https://wiki.archlinux.org/index.php/Libvirt) is useful here to understand all the details, but these are all fairly default Linux tools.
    - to set up your VMs, you can use `virsh` (command line tool) or `virt-manager` (graphical interface). For initial testing I preferred `virt-manager`, but once things are fully automated there isn't necessarily a need for the GUI. You can also generate your VM through the graphical interface, and then edit the config using `virsh`.
    - most guides will explain how to add USB device passthrough - however, if we want to stream the VM to a remote computer, we'll be using some form of USB over IP, so this isn't necessary
    - once you've created your Windows VM (again referring to [this guide](https://forum.level1techs.com/t/vfio-in-2019-pop-os-how-to-general-guide-though-draft/142287]), you can add the PCI device using `virt-manager` or `virsh`. [This guide](https://heiko-sieger.info/running-windows-10-on-linux-using-kvm-with-vga-passthrough/) has some nice details on creating a manual configuration file for your VM, but I never really got it working
    - with nvidia GPU's, Windows may not accept a virtual device with a cryptic `error 43`. You can fix this by [again using `virsh` and editing your config appropriately.](https://mathiashueber.com/fighting-error-43-nvidia-gpu-virtual-machine/)
    - networking should work fine by default, but for some applications/purposes you may prefer a bridged network (e.g. if you want your VM to appear on the same subdomain as the rest of your host's local network). The best advice I found was [here](https://forum.level1techs.com/t/cant-seem-to-configure-a-bridge-for-windows-guest-in-virt-manager-update-trying-to-use-virtio/111719/13), but it wasn't super clean. If you want to run multiple machines bridged, you may need a separate network card with multiple physical outputs - there's probably a cleaner way to do this in software rather than trying to force it within the virtual machine config
    - if you're trying to pass multiple CPU cores to your VM, you'll need to change the CPU topology in your VM config (again, `virt-manager` or `virsh`). [This advice](http://www.openwebit.com/c/how-to-run-windows-vm-on-more-than-2-cores-under-kvm/) worked for me.